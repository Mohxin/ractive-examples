<!doctype html>
<html>
<head>
	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
	<link href='https://fonts.googleapis.com/css?family=Voltaire' rel='stylesheet' type='text/css'>
	<!-- JQuery -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<!-- Ractive -->
	<script src='https://cdn.jsdelivr.net/npm/ractive'></script>
	<!-- A bit of style -->
	<style>
		body {
			background-color:#eee;
			min-height:100%;
			font-family:Voltaire;
		}
	</style>
</head>
<body>

	<div id="target" class="container"></div>
	
	<script id='template' type='text/ractive'>
		<p>Note: apparently, this does not work on IE &lt;= 11</p>
		<h2>Native way</h2>
		<div class="row">
			<div class="col-sm-6">
				<ul class="list-group">
					<li class="list-group-item" draggable="true" ondragstart="drag(event)">Apple</li>
					<li class="list-group-item" draggable="true" ondragstart="drag(event)">Banana</li>
					<li class="list-group-item" draggable="true" ondragstart="drag(event)">Cherry</li>
				</ul>
			</div>
			<div class="col-sm-6">
				<ul class="list-group" ondrop="drop(event)" ondragover="allowDrop(event)">
					<li class="list-group-item">Drop stuff here</li>
				</ul>
			</div>
		</div>
		
		<h2>Data-bound</h2>
		<div class="row">
			<div class="col-sm-6">
				<ul class="list-group">
					{{#each fruits}}
						<li class="list-group-item" draggable="true" on-dragstart="@this.drag(@event, @keypath)">{{this}}</li>
					{{/each}}
				</ul>
			</div>
			<div class="col-sm-6">
				<ul class="list-group" on-drop="@this.drop(@event)" on-dragover="@this.allowDrop(@event)">
				{{#each dropped}}
					<li class="list-group-item">{{this}}</li>
				{{/each}}
				{{#unless dropped}}
					<li class="list-group-item"><i style="color:gray">Drop stuff here</i></li>
				{{/unless}}
				</ul>
			</div>
		</div>
		
		<h2>Using decorators</h2>
		<div class="row">
			<div class="col-sm-6">
				<ul class="list-group">
					{{#each fruits}}
						<li class="list-group-item" as-draggable="@keypath">{{this}}</li>
					{{/each}}
				</ul>
			</div>
			<div class="col-sm-6">
				<ul class="list-group" as-dropzone="'copy_to', 'dropped'">
					{{#each dropped}}
						<li class="list-group-item" as-draggable="">{{this}}</li>
					{{/each}}
					{{#unless dropped}}
						<li class="list-group-item"><i style="color:gray">Drop stuff here</i></li>
					{{/unless}}
				</ul>
			</div>
		</div>
	</script>

	<script>
		// For native way
		
		function allowDrop(ev) {
			ev.preventDefault();
		}

		function drag(ev) {
			console.debug(ev.target.outerHTML);
			ev.dataTransfer.setData("text", ev.target.outerHTML);
		}

		function drop(ev) {
			ev.preventDefault();
			var data = ev.dataTransfer.getData("text");
			ev.currentTarget.innerHTML += data;
		}
		
		// Draggable & dropzone decorators
		
		Ractive.decorators['draggable'] = function(node, kp) {
			console.debug('draggable: ' + node + " - " + kp)
			node.draggable = true;
			node.addEventListener('dragstart', function(ev) {
				ev.dataTransfer.setData("text", kp);
			});
			return {
				teardown: function() {
					node.removeEventListener('dragstart');
				}
			};
		}
		
		Ractive.decorators['dropzone'] = function(node, action, target, source) {
			console.debug(node)
			console.debug(action)
			console.debug(target)
			console.debug(source)
			var self = this;
			node.addEventListener('dragover', function(ev) {
				ev.preventDefault();
			});
			node.addEventListener('drop', function(ev) {
				ev.preventDefault();
				var kp = ev.dataTransfer.getData("text");
				var item = self.get(kp);
				console.debug(item);
				self.push(target, item);
			});
			return {
				teardown: function() {
					node.removeEventListener('dragover');
					node.removeEventListener('drop');
				}
			};
		}
		
		
		var ractive = new Ractive({
			target: '#target',
			template: '#template',
			data: {
				fruits: ['Apple', 'Banana', 'Cherry', 'Donut'],
				dropped: []
			},
			// for manual databound example
			allowDrop: function(ev) {
				console.debug(ev);
				ev.preventDefault();
			},
			drag: function(ev, kp) {
				console.debug(ev);
				ev.dataTransfer.setData("text", kp);
			},
			drop: function(ev) {
				console.debug(ev);
				ev.preventDefault();
				var kp = ev.dataTransfer.getData("text");
				this.push('dropped', this.get(kp));
			}
		});
	</script>
</body>
</html>
